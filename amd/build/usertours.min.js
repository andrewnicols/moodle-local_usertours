define(["core/ajax","local_usertours/tour","jquery","core/templates","core/str"],function(a,b,c,d,e){var f={tourId:null,currentTour:null,context:null,init:function(a,b,d){f.tourId=a,f.context=d,"undefined"==typeof b&&(b=!0),b&&f.fetchTour(a),f.addResetLink(),c("body").on("click",'[data-action="local_usertours/resetpagetour"]',function(a){a.preventDefault(),f.resetTourState(f.tourId)})},fetchTour:function(b){c.when(a.call([{methodname:"local_usertours_fetch_tour",args:{tourid:b,context:f.context,pageurl:window.location.href}}])[0],d.render("local_usertours/tourstep",{})).then(function(a,c){f.startBootstrapTour(b,c[0],a.tourConfig)})},addResetLink:function(){e.get_string("resettouronpage","local_usertours").done(function(a){c("footer, .logininfo").last().append('<div class="usertour"><a href="#" data-action="local_usertours/resetpagetour">'+a+"</a></div>")})},startBootstrapTour:function(a,c,d){f.currentTour&&(d.onEnd=null,f.currentTour.endTour(),delete f.currentTour),d.onEnd=f.markTourComplete,d.onShown=f.markStepShown,d.eventHandlers={afterEnd:[f.markTourComplete]},d.tourName=d.name,delete d.name,d.template=c,d.steps=d.steps.map(function(a){return"undefined"!=typeof a.element&&(a.target=a.element,delete a.element),"undefined"!=typeof a.reflex&&(a.moveOnClick=!!a.reflex,delete a.reflex),"undefined"!=typeof a.content&&(a.body=a.content,delete a.content),a}),d.steps[2].delay=250,f.currentTour=new b(d),f.currentTour.startTour()},markStepShown:function(b){a.call([{methodname:"local_usertours_step_shown",args:{tourid:f.tourId,context:f.context,pageurl:window.location.href,stepid:b.getStep(b.getCurrentStep()).stepid,stepindex:b.getCurrentStep()}}])},markTourComplete:function(b){a.call([{methodname:"local_usertours_complete_tour",args:{tourid:f.tourId,context:f.context,pageurl:window.location.href,stepid:b.getStep(b.getCurrentStep()).stepid,stepindex:b.getCurrentStep()}}])},resetTourState:function(b){a.call([{methodname:"local_usertours_reset_tour",args:{tourid:b,context:f.context,pageurl:window.location.href},done:function(a){a.startTour&&f.fetchTour(a.startTour)}}])}};return{init:f.init,resetTourState:f.resetTourState}});